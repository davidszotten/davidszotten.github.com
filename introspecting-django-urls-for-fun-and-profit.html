<!DOCTYPE html>
<html lang="en">
<head>
        <title>Introspecting django urls for fun and profit</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="./theme/css/main.css" type="text/css" />
        <link href="./feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="davidszotten ATOM Feed" />
        

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie.css"/>
                <script src="./js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">

    <header id="banner" class="body">
            <h1><a href=".">davidszotten </a></h1>
    </header><!-- /#banner -->
    <div id="container">
        <nav><ul>
        
            <li><a href="./about.html">about</a></li>

        
        
        
        
        
            <li class="active"><a href="./category/blog.html">blog</a></li>
        
        </ul></nav>

                
<section id="content" class="body">    
<article>
        <header> <h1 class="entry-title"><a href=""
        rel="bookmark" title="Permalink to Introspecting django urls for fun and profit">Introspecting django urls for fun and profit</a></h1>  </header>
        <div class="entry-content">
        <footer class="post-info">
<p>
        <abbr class="published" title="2012-04-14T00:00:00">
                Sat 14 April 2012
        </abbr>

</p>
<p>tags: <a href="./tag/django.html">django</a> <a href="./tag/python.html">python</a> </p>


</footer><!-- /.post-info -->
        <p>One of the projects I work on has a fairly large and old code base, and is unfortunately somewhat lacking in the test suite department. We are working to improve this, but in the medium term we are stuck with a fair amount of manual testing.</p>
<p>As part of some recent development, a lot of the urls were getting a new parameter, and during some (manual) testing i discovered a view that hadn't had its signature updated to match the new url pattern. This got me thinking that there ought to be some way to automatically look for this. Ideally such bugs shuold be covered in other automatic tests but maybe some code in(tro/)spection could help with some of these issues in the short to intermediate term.</p>
<p>Definitely worth a couple of hours to see what we can do.</p>
<h1>Gameplan</h1>
<ol>
<li>Get a list of url patterns from django</li>
<li>Check which keywords are captured in the url</li>
<li>Match these keywords against the arguments in the view</li>
<li>Highlight any mismatches</li>
<li>Profit</li>
</ol>
<h3>1. Get a list of url patterns from django</h3>
<p>Some googling turned up a fairly simple way to get at all the patterns</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">urls</span>

<span class="k">def</span> <span class="nf">traverse</span><span class="p">(</span><span class="n">patterns</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
        <span class="n">do_something</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="s">&#39;url_patterns&#39;</span><span class="p">):</span>
            <span class="n">traverse</span><span class="p">(</span><span class="n">pattern</span><span class="o">.</span><span class="n">url_patterns</span><span class="p">)</span>
</pre></div>


<h3>2. Check for keywords captured in the url</h3>
<p>Each entry form the url patterns contains a reference to the regex it uses to match urls. It turns out there are a nice few ways to introspect regexes.</p>
<p><code>regex.pattern</code> returns the string with the regex pattern. For some reason tab completion (I use <a href="http://ipython.org/">IPython</a>) doesn't help you discover this</p>
<div class="codehilite"><pre><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">re</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;some pattern&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">regex</span><span class="o">.</span> <span class="c"># &lt;TAB&gt;</span>
<span class="n">r</span><span class="o">.</span><span class="n">__copy__</span>      <span class="n">r</span><span class="o">.</span><span class="n">findall</span>       <span class="n">r</span><span class="o">.</span><span class="n">match</span>         <span class="n">r</span><span class="o">.</span><span class="n">search</span>        <span class="n">r</span><span class="o">.</span><span class="n">sub</span>
<span class="n">r</span><span class="o">.</span><span class="n">__deepcopy__</span>  <span class="n">r</span><span class="o">.</span><span class="n">finditer</span>      <span class="n">r</span><span class="o">.</span><span class="n">scanner</span>       <span class="n">r</span><span class="o">.</span><span class="n">split</span>         <span class="n">r</span><span class="o">.</span><span class="n">subn</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">regex</span><span class="o">.</span><span class="n">pattern</span>
<span class="s">&#39;some pattern&#39;</span>
</pre></div>


<p>So we can access the pattern. Now to find captured groups and their names. Pass the pattern though custom regex? No need it turns out. A regex object has more hidden properties we can use to introspect it.</p>
<div class="codehilite"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;capture (?P&lt;some&gt;\w+) group&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">regex</span><span class="o">.</span><span class="n">groups</span>
<span class="mi">1</span>
</pre></div>


<p>Nice! However, this isn't quite what we want:</p>
<div class="codehilite"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;capture (?P&lt;some&gt;(foo|bar)baz) group&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">regex</span><span class="o">.</span><span class="n">groups</span>
<span class="mi">2</span>
</pre></div>


<p>Sure, there are two groups, but I only care about the named ones. Back in the docs, we find</p>
<div class="codehilite"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">regex</span><span class="o">.</span><span class="n">groupindex</span>
<span class="p">{</span><span class="s">&#39;some&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
</pre></div>


<p>Aha! Perfext, just what we want. Even contains the name of the captured parameter. (The value is the order of the group in the regex.)</p>
<h4>Not quite everything</h4>
<p>There are a few more considerations. For example, django lets us pass extra keyword arguments to the view, aside from ones captured in the url. These may be accessed via <code>entry.default_args</code>. Throughout I will also assume that we only use named capture groups in our urlpatterns.</p>
<h3>3. Match the keywords against the arguments in the view</h3>
<p>The view can be accessed as <code>entry.callback</code>. Not every url pattern has a callback, since some just import other patterns.</p>
<p>Once we have a reference to the function, we can start using the <code>inspect</code> module from the standard library.</p>
<div class="codehilite"><pre><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">inspect</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">callback</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">callback</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
<span class="n">ArgSpec</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;request&#39;</span><span class="p">,</span> <span class="s">&#39;event_slug&#39;</span><span class="p">],</span> <span class="n">varargs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">keywords</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
</pre></div>


<p>All useful stuff. <code>args</code> is the function signature. <code>varargs</code> and <code>keywords</code> contain the names of variables with <code>*</code> and <code>**</code> respectively. Typically these are named <code>args</code> and <code>kwargs</code>. In my experience, these are unusual in view functions, but as we shall see later, they do appear if we are using function decorators. <code>defautls</code> may be a duple of default argument values specified. These correspond to the n last arguments.</p>
<p>So, we should no be able to do something like</p>
<div class="codehilite"><pre><span class="k">def</span> <span class="nf">check_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">):</span>
    <span class="n">default_args</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="s">&#39;default_args&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="c"># add the &#39;request&#39; argument, which won&#39;t be in the url</span>
    <span class="n">kwargs_provided</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s">&#39;request&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">default_args</span><span class="p">)</span>
    <span class="n">captured_kwargs</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">groupindex</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">kwargs_provided</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">captured_kwargs</span><span class="p">)</span>

    <span class="n">argspec</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">callback</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">argspec</span><span class="o">.</span><span class="n">args</span>
    <span class="n">defaults</span> <span class="o">=</span> <span class="n">argspec</span><span class="o">.</span><span class="n">defaults</span>
    <span class="k">if</span> <span class="n">defaults</span><span class="p">:</span>
        <span class="n">required_args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">defaults</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">required_args</span> <span class="o">=</span> <span class="n">args</span>

    <span class="n">missing_kwargs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">required_args</span><span class="p">)</span> <span class="o">-</span> <span class="n">kwargs_provided</span>
    <span class="k">if</span> <span class="n">missing_kwargs</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">: view requires kwargs </span><span class="si">%s</span><span class="s"> not in the url kwargs&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">entry</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">missing_kwargs</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">argspec</span><span class="o">.</span><span class="n">keywords</span><span class="p">:</span>
        <span class="c"># signature contains **kwargs, so can&#39;t do second check</span>
        <span class="k">return</span>

    <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="n">kwargs_provided</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">extra_kwargs</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">: url provides kwargs </span><span class="si">%s</span><span class="s"> not in the view signature&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">entry</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">extra_kwargs</span><span class="p">))</span>
</pre></div>


<h3>4. Highlight any mismatches?</h3>
<p>Running <code>check_entry</code> agains my urlconf threw up a whole bunch of false alarms. It turns out the problem was decorators. A whole bunch of my views were decorated, e.g. with <code>@permission_required</code>. Of course, <code>entry</code> doesn't know that it's callback has been swiched out for another function, but maybe we can figure it out. Some investigation turned up the <code>func_closure</code> property of functions, containing references to items in their closure. And decorated functions, contain a reference to the oringinal function there. To get at it, some trickery and guessing is required</p>
<div class="codehilite"><pre><span class="k">def</span> <span class="nf">guess_wrapper</span><span class="p">(</span><span class="n">cells</span><span class="p">):</span>
    <span class="c"># look through the funciton closure for cells that look</span>
    <span class="c"># like wrapped functions. for multuple functions,</span>
    <span class="c"># attempt to guess which is the more likely candidate</span>

    <span class="c"># we add points for</span>
    <span class="c"># * non-lambda</span>
    <span class="c"># * &#39;request&#39; in arg list</span>

    <span class="n">functions</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">:</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">cell_contents</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">contents</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">contents</span><span class="o">.</span><span class="n">__name__</span> <span class="o">!=</span> <span class="s">&#39;&lt;lambda&gt;&#39;</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="s">&#39;request&#39;</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">functions</span><span class="p">[</span><span class="n">score</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">score</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">functions</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
        <span class="k">return</span> <span class="n">functions</span><span class="p">[</span><span class="n">score</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">unwrap</span><span class="p">(</span><span class="n">callback</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">while</span> <span class="n">callback</span><span class="o">.</span><span class="n">func_closure</span><span class="p">:</span>
            <span class="n">do_compare</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
            <span class="n">cells</span> <span class="o">=</span> <span class="n">callback</span><span class="o">.</span><span class="n">func_closure</span>
            <span class="n">guess</span> <span class="o">=</span> <span class="n">guess_wrapper</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">guess</span><span class="p">:</span>
                <span class="n">callback</span> <span class="o">=</span> <span class="n">guess</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># nothing in the closure was a function, so give up</span>
                <span class="k">break</span>
        <span class="n">do_compare</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
</pre></div>


<h3>Profilt?</h3>
<p>Putting this all together in a django management command, we get a nice tool to help with finding bugs, especially around refactoring a django probject.  The complete thing may be found on github, as <a href="https://github.com/davidszotten/django-urls-introspect">django-urls-introspect</a></p>
<p>Using the command I was able to find a few issues and get them sorted.</p>
<div class="codehilite"><pre><span class="o">./</span><span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">check_urls</span>
<span class="n">edit</span><span class="o">-</span><span class="n">members:</span> <span class="n">url</span> <span class="n">provides</span> <span class="n">kwargs</span> <span class="p">[</span><span class="s">&#39;member_id&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="n">in</span> <span class="n">the</span> <span class="n">view</span> <span class="n">sinature</span>
</pre></div>


<p>Is this a stupid idea? Do let me know. Any other thoughts/comments also welome.</p>
        </div><!-- /.entry-content -->
        
        <div class="comments">
        <h2>Comments !</h2>
            <div id="disqus_thread"></div>
            <script type="text/javascript">
               var disqus_identifier = "introspecting-django-urls-for-fun-and-profit.html";
               (function() {
               var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
               dsq.src = 'http://davidszottenblog.disqus.com/embed.js';
               (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
              })();
            </script>
        </div>
        

</article>
</section>

    </div>
    


    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-9812324-6");
    pageTracker._trackPageview();
    } catch(err) {}</script>



<script type="text/javascript">
    var disqus_shortname = 'davidszottenblog';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

</body>
</html>